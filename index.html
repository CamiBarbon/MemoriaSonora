<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tilt+Neon&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
  <title>Juego: Memoria Sonora</title>
</head>
<body>

<!-- PANTALLA INICIAL -->
<div id="startScreen">
<div id="startTitle" class="neon-title">MEMORIA <span class="accent">SONORA</span></div>
  <button id="startBtn">COMENZAR</button>
  <div style="font-size:13px;color:#37bcdd;opacity:0.9">Hacé clic en comenzar para desbloquear el audio y ver el juego.</div>
</div>

<!-- TRANSICIÓN ENTRE START Y JUEGO -->
<div id="transitionScreen" class="transition-screen" style="display:none">
  <div class="transition-cd"></div>
</div>

<!-- JUEGO (oculto hasta click en comenzar) -->
 <audio id="previewAudio" src="mp3/level1_preview.mp3" preload="auto"></audio>
<div class="stage" id="gameStage" style="display:none">
  <div class="header">
<div class="title neon-title">MEMORIA <span class="accent">SONORA</span></div>
    <div class="cd-wrap">
      <div id="cd" class="cd spin" title="CD preview"></div>
      <div style="font-size:12px;opacity:0.8">Nivel <span id="levelLabel">1</span></div>
    </div>
  </div>

  <div class="main">
    <div class="left-col">
      <div class="game-area">
        <div id="gridBack" class="grid-back">
          <!-- background under grid: usa la imagen en carpeta /img -->
          <div id="bgImage" class="bg-image" style="background-image: url('img/soft-cell.jpg');"></div>
          <div id="grid" class="grid"></div>
        </div>

        <div class="controls">
          <button id="repeatBtn" class="btn cyan">VOLVER A ESCUCHAR CANCIÓN</button>
        </div>
      </div>

      <div style="margin-top:8px;font-size:13px;color:#bfe9ff;opacity:0.9"><span id="status">esperando</span></div>
    </div>

    <aside class="right-col">
      <div class="sidebar">
        <h4>Cómo jugar</h4>
        <div class="instr" id="instructions">
          1) Prestá atención al fragmento del tema del inicio.<br>
          2) Luego, la cuadrícula se habilita. Cada casilla esconde un beat.<br>
          3) Clickeá para revelar los beats en orden. Si errás, la secuencia se reinicia.<br>
          4) Al completar, pasas de nivel! 
        </div>

        <div class="icons">
          <div class="icon" id="levelArtist"><strong></strong></div>
        </div>
      </div>
    </aside>
  </div>
</div>
<!-- overlay animado de nivel completado -->
<div id="levelCompleteOverlay" class="level-complete-overlay" style="display:none">
  <div class="bg-zoom"></div>
  <div class="context-info">
    <h2 id="contextTitle">Contexto Histórico</h2>
    <p id="contextText1">(texto histórico técnico y sociocultural...)</p>
    <p id="contextText2">(apropiaciones posteriores y presentación del siguiente nivel...)</p>
    <button id="nextLevelBtn" class="btn pink">JUGAR SIGUIENTE NIVEL</button>
  </div>
</div>
<script>
/* ==============================
   CONFIG
============================== */
const GRID_COLS = 4;
const GRID_ROWS = 4;
const TOTAL_TILES = GRID_COLS * GRID_ROWS; // 16
const INITIAL_PREVIEW_MS = 25000; // 25s

const LEVELS = [
  {
    id: 1,
    label: 'Gloria Jones (1973)',
    bg: 'img/gloria-jones.jpg',
    preview: 'mp3/level1_preview.mp3',
    correctSequence: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],
    overlay: {
      title: 'Historia y contexto — Gloria Jones',
      text1: 'La versión original de “Tainted Love” fue grabada por Gloria Jones en 1965 dentro del circuito soul de la época, influenciada por el sonido Motown pero con una energía más cruda y directa. La canción nunca tuvo gran impacto en su lanzamiento inicial, pero con el tiempo se volvió un clásico oculto dentro de la cultura Northern Soul británica, donde los DJ rescataban joyas rítmicas poco conocidas para los clubes nocturnos. El pulso soul original funciona como la “memoria base” es la raíz emocional desde donde las demás adaptaciones se construyen, exageran o contradicen.',
      text2: 'El siguiente nivel se explora otra reinterpretación del tema, con un estilo synthpop de los 80.'
    }
  },
  {
    id: 2,
    label: 'Soft Cell (1981)',
    bg: 'img/soft-cell.jpg',
    preview: 'mp3/level2_preview.mp3',
    correctSequence: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15],
    overlay: {
      title: 'Historia y contexto — Soft Cell',
      text1: 'La banda no solo versionó la canción: la reprogramó. Su reinterpretación desplaza la emocionalidad soul hacia una sensibilidad más fría, marcada por la artificialidad y la máquina. Este gesto convierte a la canción en un icono de época, demostrando cómo una obra puede mutar radicalmente al ser atravesada con nuevas tecnologías. Los sintetizadores analógicos, la repetición mecánica y la estética new wave convirtieron el tema en un símbolo de la cultura nocturna de comienzos de los 80. La versión alcanzó éxito global y definió buena parte de la identidad sonora del pop electrónico.',
      text2: 'En el próximo nivel podremos explorar otro estilo y época musical.'
    }
  }
];

/* ==============================
   STATE
============================== */
let currentLevelIndex = 0;
let tiles = [];
let userSequence = [];
let active = false;
let revealedCount = 0;

/* ==============================
   DOM ELEMENTS
============================== */
const startBtn = document.getElementById('startBtn');
const startScreen = document.getElementById('startScreen');
const gameStage = document.getElementById('gameStage');
const gridEl = document.getElementById('grid');
const bgImage = document.getElementById('bgImage');
const cd = document.getElementById('cd');
const previewAudio = document.getElementById('previewAudio');
const status = document.getElementById('status');
const levelLabel = document.getElementById('levelLabel');
const overlay = document.getElementById('levelCompleteOverlay');

/* ==============================
   HELPERS
============================== */
function setStatus(s){ status.textContent = s; }

function renderGrid(){
  gridEl.innerHTML = '';
  tiles = [];
  for(let i=0; i<TOTAL_TILES; i++){
    const t = document.createElement('div');
    t.className = 'tile';
    t.dataset.idx = i;
    t.addEventListener('click', ()=> onTileClick(i,t));
    gridEl.appendChild(t);
    tiles.push(t);
  }
}

function playBeat(levelId, beatIndex){
  return new Promise((resolve) => {
    const audio = beatAudios[beatIndex]; // Tomamos el audio pre-cargado
    if(!audio) {
      console.error(`No se encontró el audio para beat ${beatIndex+1} del nivel ${levelId}`);
      resolve();
      return;
    }
    audio.currentTime = 0; // Reiniciar al inicio
    const playPromise = audio.play();
    if(playPromise !== undefined){
      playPromise.catch(()=>{}).then(() => {});
    }
    audio.onended = resolve; // Resolver la promesa cuando termina
  });
}

function updateBgOpacity(){
  const min = 0.40;
  const max = 0.75;
  const ratio = Math.min(revealedCount / TOTAL_TILES, 1);
  bgImage.style.opacity = (min + (max - min) * ratio).toString();
}

/* ==============================
   GRID INTERACTION
============================== */
async function onTileClick(i, tileEl){
  if(!active) return;
  if(tileEl.classList.contains('revealed')) return;

  const level = LEVELS[currentLevelIndex];

  active = false;
  tileEl.classList.add('revealed');

  await playBeat(level.id, i);
  userSequence.push(i);
  validateSequence();
  active = true;
}

function validateSequence(){
  const level = LEVELS[currentLevelIndex];
  const correct = level.correctSequence;

  for(let k=0;k<userSequence.length;k++){
    if(userSequence[k] !== correct[k]){
      setStatus('No es el beat que sigue! Volvé a empezar :(');
      active = false;
      setTimeout(()=>{
        tiles.forEach(t=>t.classList.remove('revealed'));
        userSequence = [];
        revealedCount = 0;
        updateBgOpacity();
        active = true;
        setStatus('jugando');
      },800);
      return;
    }
  }

  if(userSequence.length === correct.length){
    setStatus('¡Buena memoria! lo lograste');
    active = false;
    setTimeout(()=> showLevelCompletePopup(), 500);
  } else {
    setStatus(`aciertos ${userSequence.length}/${correct.length}`);
  }
}

/* ==============================
   AUDIO
============================== */
function playPreview(){
  return new Promise((resolve)=>{
    try{
      previewAudio.currentTime = 0;
      const p = previewAudio.play();
      if(p!==undefined) p.catch(()=>{}).then(()=>{});
    } catch(e){}
    setTimeout(()=> { previewAudio.pause(); resolve(); }, INITIAL_PREVIEW_MS);
  });
}

/* ==============================
   LEVEL MANAGEMENT
============================== */
let beatAudios = [];
function loadLevel(idx){
  currentLevelIndex = idx;
  const L = LEVELS[idx];
  levelLabel.textContent = L.id;

  // Actualizar imagen de fondo del grid
  bgImage.style.backgroundImage = `url('${L.bg}')`;

  // Pre-cargar todos los beats de este nivel
  beatAudios = [];
  for(let i = 0; i < TOTAL_TILES; i++){
    const audio = new Audio(`mp3/level${L.id}_beat${i+1}.mp3`);
    beatAudios.push(audio);
  }
  // actualizar artista en sidebar
    const artistDiv = document.getElementById('levelArtist');
    if(artistDiv) artistDiv.innerHTML = `<strong>${L.label}</strong>`;

  // Cargar audio de preview del nivel
  previewAudio.src = L.preview;

  // Resetear tiles y secuencia
  tiles.forEach(t => t.classList.remove('revealed'));
  userSequence = [];
  revealedCount = 0;
  updateBgOpacity();
  active = false;
  setStatus('Escuchá y recordá...');

  // Animación del CD
  cd.classList.add('spin');

  // Reproducir preview
  playPreview().then(() => {
    cd.classList.remove('spin');
    setTimeout(() => { enableGrid(); }, 250);
  });
}
 

function enableGrid(){
  tiles.forEach(t=> t.classList.remove('revealed'));
  active = true;
  setStatus('¡Momento de jugar!');
}

function nextLevel(){
  const next = currentLevelIndex + 1;
  if(next < LEVELS.length) loadLevel(next);
  else alert('Has completado todos los niveles (demo).');
}

/* ==============================
   OVERLAY DE NIVEL COMPLETADO
============================== */
function showLevelCompletePopup() {
  const overlay = document.getElementById('levelCompleteOverlay');
  const L = LEVELS[currentLevelIndex];

  // actualizar bg y textos
  overlay.querySelector('.bg-zoom').style.backgroundImage = `url('${L.bg}')`;
  overlay.querySelector('#contextTitle').textContent = `Tainted Love — ${L.label}`;
  overlay.querySelector('#contextText1').textContent = L.overlay.text1;
  overlay.querySelector('#contextText2').textContent = L.overlay.text2;

  // mostrar overlay y disparar animación
  overlay.style.display = 'flex';
  setTimeout(() => overlay.classList.add('zoomed'), 50);

  // vincular botón siguiente nivel
  const nextBtn = overlay.querySelector('#nextLevelBtn');
  nextBtn.onclick = () => {
    overlay.classList.remove('zoomed');
    setTimeout(() => {
      overlay.style.display = 'none';
      nextLevel(); // carga el siguiente nivel
    }, 800);
  };
}

// nextLevel() carga siguiente nivel o muestra mensaje final
function nextLevel() {
  const nextIndex = currentLevelIndex + 1;
  if(nextIndex < LEVELS.length){
    loadLevel(nextIndex);
  } else {
    alert('Has completado todos los niveles (demo).');
  }
}

/* ==============================
   START GAME
============================== */
startBtn.addEventListener('click', ()=>{
  startScreen.style.display = 'none';
  const ts = document.getElementById('transitionScreen');
  ts.style.display = 'flex';

  setTimeout(()=>{
    ts.style.display = 'none';
    gameStage.style.display = 'block';
    renderGrid();
    bindButtons();
    loadLevel(0);
  },1500);
});

function bindButtons(){
  document.getElementById('repeatBtn').addEventListener('click', ()=> playPreview());
}
</script>
</body>
</html>
