<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tilt+Neon&display=swap" rel="stylesheet">
  <title>Juego: Memoria Sonora</title>
  <style>
    :root{
      --bg:#0b0710; --neon-cyan:#00e0ff; --neon-pink:#ff2fa8;
      --glass: rgba(255,255,255,0.06);
      --tile-opaque: 1; --tile-hidden: 0.18;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
        font-family: 'Tilt Neon', sans-serif;
      background: radial-gradient(ellipse at 20% 10%, rgba(255,20,200,0.03), transparent 10%),
                  linear-gradient(180deg,#05040a 0%, #090617 60%);
      color:#e6f7ff; -webkit-font-smoothing:antialiased;
      display:flex;align-items:center;justify-content:center;padding:24px;
    }

    /* START SCREEN */
    #startScreen{
      position:fixed; inset:0; background:#05040a;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:30px; z-index:1000;
    }
    #startTitle{
      font-size:64px; font-weight:700; letter-spacing:3px; color:var(--neon-cyan);
      text-shadow:0 0 18px rgba(0,224,255,0.3);
    }
    #startBtn{
      padding:18px 36px; font-size:20px; border-radius:10px;
      border:3px solid rgba(0,224,255,0.3); background:transparent; color:var(--neon-pink);
      cursor:pointer; text-shadow:0 0 8px rgba(255,47,168,0.2);
    }
    /* TRANSITION SCREEN */
.transition-screen{
  position:fixed;
  inset:0;
  background:#05040a;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1200;
}

.transition-cd{
  width:220px;
  height:220px;
  border-radius:50%;
  background:conic-gradient(#222 0 25%, #444 25% 50%, #111 50% 75%, #333 75% 100%);
  position:relative;
  animation: cdZoomSpin 1.5s ease-out forwards;
  box-shadow:0 0 35px rgba(255,0,150,0.15), 0 0 60px rgba(0,224,255,0.12);
}

.transition-cd::after{
  content:'';
  position:absolute;
  left:50%; top:50%;
  transform:translate(-50%,-50%);
  width:40px; height:40px;
  border-radius:50%;
  background:rgba(0,0,0,0.6);
}

@keyframes cdZoomSpin{
  0%{
    transform:scale(0.6) rotate(0deg);
    opacity:0;
  }
  12%{
    opacity:1;
  }
  100%{
    transform:scale(1.15) rotate(360deg);
    opacity:1;
  }
}
    /* STAGE / GAME LAYOUT */
    .stage{width:1100px; max-width:100%; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:20px; box-shadow: 0 8px 30px rgba(0,0,0,0.7)}
    .header{display:flex;align-items:center;gap:20px;margin-bottom:18px}
    .title{font-weight:700;font-size:44px;letter-spacing:2px;color:var(--neon-cyan);text-shadow:0 0 12px rgba(0,224,255,0.14)}
    .title .accent{color:var(--neon-pink); margin-left:8px}
    .cd-wrap{margin-left:auto;display:flex;align-items:center;gap:8px}
    .cd{width:72px;height:72px;border-radius:50%;background:conic-gradient(#222 0 25%, #444 25% 50%, #111 50% 75%, #333 75% 100%);position:relative;box-shadow:0 0 18px rgba(255,0,150,0.06)}
    .cd:after{content:'';position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:rgba(0,0,0,0.6)}
    .spin{animation:spin 2s linear infinite}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

    .main{display:flex;gap:18px}
    .left-col{flex:1;display:flex;flex-direction:column;gap:14px}
    .right-col{width:260px}

    /* GRID 5x4 = 20 tiles */
    .game-area{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.05));border-radius:8px;padding:14px;display:flex;flex-direction:column;align-items:center}
    .grid-back{width:860px;max-width:100%;height:360px;background-size:cover;background-position:center;border-radius:6px;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .bg-image{position:absolute;inset:0;background-size:cover;background-position:center;filter:contrast(0.95) saturate(1.1) brightness(0.7);opacity:0.22;transition:opacity .22s linear}
    .grid{position:relative;display:grid;grid-template-columns:repeat(5,1fr);grid-template-rows:repeat(4,1fr);width:94%;height:86%;gap:6px;padding:10px;z-index:2}
    .tile{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));border-radius:4px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:transform 120ms, background 160ms, opacity 220ms;opacity:var(--tile-hidden)}
    .tile.revealed{opacity:var(--tile-opaque);box-shadow:0 6px 20px rgba(0,0,0,0.55), inset 0 0 40px rgba(255,255,255,0.02); background: rgba(255,255,255,0.08)}
    .tile:active{transform:scale(0.98)}

    .controls{display:flex;gap:16px;margin-top:16px}
    .btn{padding:12px 20px;border-radius:8px;border:3px solid rgba(255,255,255,0.06);font-weight:700;letter-spacing:1px;cursor:pointer}
    .btn.cyan{background:transparent;color:var(--neon-cyan);border-color:rgba(0,224,255,0.18);text-shadow:0 0 8px rgba(0,224,255,0.08)}
    .btn.pink{background:transparent;color:var(--neon-pink);border-color:rgba(255,47,168,0.18);text-shadow:0 0 8px rgba(255,47,168,0.08)}

    .sidebar{background:var(--glass);border-radius:8px;padding:12px;height:360px;display:flex;flex-direction:column;gap:12px}
    .sidebar h4{font-size:14px;color:#f3f8ff}
    .instr{font-size:13px;line-height:1.45;color:#d6f3ff;opacity:0.95}
    .icons{display:flex;flex-direction:column;gap:10px;margin-top:auto}
    .icon{display:flex;align-items:center;gap:10px;padding:8px;border-radius:6px;background:rgba(255,255,255,0.01)}

    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.82));z-index:999}
    .card{background:rgba(10,10,12,0.86);border-radius:10px;padding:22px;max-width:820px;width:94%;color:#e6f7ff}
    .card h3{color:var(--neon-pink);margin-bottom:8px}
    .card p{color:#cfefff;opacity:0.95;margin-bottom:10px}
    .card .card-actions{display:flex;gap:12px;justify-content:flex-end}

    @media (max-width:1000px){
      .grid{grid-template-columns:repeat(4,1fr)}
      .grid-back{height:420px}
      .right-col{display:none}
    }
  </style>
</head>
<body>

<!-- PANTALLA INICIAL -->
<div id="startScreen">
  <div id="startTitle">MEMORIA SONORA</div>
  <button id="startBtn">COMENZAR</button>
  <div style="font-size:13px;color:#ff4fff;opacity:0.9">Hac√© clic en comenzar para desbloquear el audio y ver el juego.</div>
</div>

<!-- TRANSICI√ìN ENTRE START Y JUEGO -->
<div id="transitionScreen" class="transition-screen" style="display:none">
  <div class="transition-cd"></div>
</div>

<!-- JUEGO (oculto hasta click en comenzar) -->
<div class="stage" id="gameStage" style="display:none">
  <div class="header">
    <div class="title">MEMORIA <span class="accent">SONORA</span></div>
    <div class="cd-wrap">
      <div id="cd" class="cd spin" title="CD preview"></div>
      <div style="font-size:12px;opacity:0.8">Nivel <span id="levelLabel">1</span></div>
    </div>
  </div>

  <div class="main">
    <div class="left-col">
      <div class="game-area">
        <div id="gridBack" class="grid-back">
          <!-- background under grid: usa la imagen en carpeta /img -->
          <div id="bgImage" class="bg-image" style="background-image: url('img/soft-cell.jpg');"></div>
          <div id="grid" class="grid"></div>
        </div>

        <div class="controls">
          <button id="repeatBtn" class="btn cyan">VOLVER A ESCUCHAR</button>
          <button id="advanceBtn" class="btn pink">AVANZAR</button>
        </div>
      </div>

      <div style="margin-top:8px;font-size:13px;color:#bfe9ff;opacity:0.9"><span id="status">esperando</span></div>
    </div>

    <aside class="right-col">
      <div class="sidebar">
        <h4>C√≥mo jugar</h4>
        <div class="instr" id="instructions">
          1) Al iniciar, suena un fragmento del tema (15s).<br>
          2) Luego, la cuadr√≠cula se habilita. Cada casilla es una porci√≥n de la imagen y esconde un beat.<br>
          3) Clicke√° para revelar casillas en orden. Si err√°s, la secuencia se reinicia.<br>
          4) Al completar, pasas de nivel! 
        </div>

        <div class="icons">
          <div class="icon">üéµ <strong>Versi√≥n:</strong> Soft Cell (1981)</div>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- overlay (nivel completado) -->
<div id="overlay" class="overlay">
  <div class="card">
    <h3 id="overlayTitle">Historia y contexto</h3>
    <p id="overlayText1">(texto hist√≥rico t√©cnico y sociocultural...)</p>
    <p id="overlayText2">(apropiaciones posteriores y presentaci√≥n del siguiente nivel...)</p>
    <div class="card-actions">
      <button id="playNext" class="btn pink">JUGAR SIGUIENTE NIVEL</button>
    </div>
  </div>
</div>

<!-- audio (precargar preview; los beat individuales se crean al vuelo) -->
<audio id="previewAudio" src="mp3/level1_preview.mp3" preload="auto"></audio>

<script>
  /* CONFIG */
  const GRID_COLS = 5;
  const GRID_ROWS = 4;
  const TOTAL_TILES = GRID_COLS * GRID_ROWS; // 20
  const INITIAL_PREVIEW_MS = 15000; // 15s

  const LEVELS = [
    {
      id:1,label:'Soft Cell (1981)', bg:'img/soft-cell.jpg', preview:'mp3/level1_preview.mp3',
      // ejemplo de secuencia: 8 pasos (indices 0..19). Modific√° seg√∫n tu audio.
      correctSequence: [2,3,8,9,12,13,16,17]
    }
  ];

  /* STATE */
  let currentLevelIndex = 0;
  let tiles = [];
  let userSequence = [];
  let active = false;
  let revealedCount = 0;

  /* DOM */
  const startBtn = document.getElementById('startBtn');
  const startScreen = document.getElementById('startScreen');
  const gameStage = document.getElementById('gameStage');
  const gridEl = document.getElementById('grid');
  const bgImage = document.getElementById('bgImage');
  const cd = document.getElementById('cd');
  const previewAudio = document.getElementById('previewAudio');
  const status = document.getElementById('status');
  const levelLabel = document.getElementById('levelLabel');

  function setStatus(s){ status.textContent = s }

  /* RENDER GRID (20 tiles) */
  function renderGrid(){
    gridEl.innerHTML = '';
    tiles = [];
    for(let i=0;i<TOTAL_TILES;i++){
      const t = document.createElement('div');
      t.className = 'tile';
      t.dataset.idx = i;
      t.addEventListener('click', ()=> onTileClick(i, t));
      gridEl.appendChild(t);
      tiles.push(t);
    }
  }

  /* Bind control buttons (repeat, advance, overlay) */
  function bindButtons(){
    document.getElementById('repeatBtn').addEventListener('click', ()=> playPreview());
    document.getElementById('advanceBtn').addEventListener('click', ()=> showLevelCompletePopup());
    document.getElementById('playNext').addEventListener('click', ()=> { hideOverlay(); nextLevel(); });
  }

  /* START BUTTON: muestra el juego y arranca el nivel (esto tambi√©n desbloquea audio en navegadores) */
startBtn.addEventListener('click', ()=>{
  startScreen.style.display = 'none';

  const ts = document.getElementById('transitionScreen');
  ts.style.display = 'flex';

  setTimeout(()=>{
    ts.style.display = 'none';
    gameStage.style.display = 'block';
    initAfterStart();
  }, 1500);  // 1.5s transici√≥n CD
});

  function initAfterStart(){
    renderGrid();
    bindButtons();
    loadLevel(0);
  }

  /* LOAD LEVEL */
  function loadLevel(idx){
    currentLevelIndex = idx;
    const L = LEVELS[idx];
    levelLabel.textContent = L.id;
    bgImage.style.backgroundImage = `url('${L.bg}')`;
    previewAudio.src = L.preview;
    // reset tiles
    tiles.forEach(t=>{ t.classList.remove('revealed'); });
    userSequence = [];
    revealedCount = 0;
    updateBgOpacity();
    active = false;
    setStatus('Cargando...');
    cd.classList.add('spin');
    playPreview().then(()=> {
      cd.classList.remove('spin');
      setTimeout(()=> { enableGrid(); }, 250);
    });
  }

  /* PLAY PREVIEW (respetar user gesture) */
  function playPreview(){
    return new Promise((resolve)=>{
      try {
        previewAudio.currentTime = 0;
        const playPromise = previewAudio.play();
        // If browser returns a promise, wait a bit; otherwise resolve after timeout
        if (playPromise !== undefined) {
          playPromise.catch(()=>{}).then(()=>{ /* started */ });
        }
      } catch(e){}
      setTimeout(()=>{ previewAudio.pause(); resolve(); }, INITIAL_PREVIEW_MS);
    });
  }

  function enableGrid(){
    // allow clicks; tiles are still visually translucent
    tiles.forEach(t=> t.classList.remove('revealed'));
    active = true; setStatus('jugando');
  }

  /* When tile clicked */
  function onTileClick(i, tileEl){
    if(!active) return;
    if(tileEl.classList.contains('revealed')) return;
    // reveal visually
    tileEl.classList.add('revealed');
    revealedCount++;
    updateBgOpacity();
    // play small beat clip (file name convention: level{n}_beat{index+1}.mp3)
    const level = LEVELS[currentLevelIndex];
    playBeat(level.id, i);
    userSequence.push(i);
    validateSequence();
  }

  function updateBgOpacity(){
    // base opacity (when 0 revealed) is 0.22 (CSS), max 1.0 when all revealed
    const base = 0.22;
    const max = 1.0;
    const ratio = Math.min(revealedCount / TOTAL_TILES, 1);
    const op = base + (max - base) * ratio;
    bgImage.style.opacity = op.toString();
  }

  function playBeat(levelId, beatIndex){
    // try to play a small clip ‚Äî ensure files exist or ignore failure
    const audio = new Audio(`mp3/level${levelId}_beat${beatIndex+1}.mp3`);
    audio.play().catch(()=>{ /* ignore */ });
  }

  function validateSequence(){
    const level = LEVELS[currentLevelIndex];
    const correct = level.correctSequence;
    // check prefix
    for(let k=0;k<userSequence.length;k++){
      if(userSequence[k] !== correct[k]){
        // mistake
        setStatus('error - reiniciando...');
        active = false;
        setTimeout(()=> {
          // hide reveals and reset sequence and revealedCount
          tiles.forEach(t=> t.classList.remove('revealed'));
          userSequence = [];
          revealedCount = 0;
          updateBgOpacity();
          active = true;
          setStatus('jugando');
        }, 800);
        return;
      }
    }
    // if completed
    if(userSequence.length === correct.length){
      setStatus('nivel completado');
      active = false;
      setTimeout(()=> showLevelCompletePopup(), 500);
    } else {
      setStatus(`aciertos ${userSequence.length}/${correct.length}`);
    }
  }

  function resetGame(){
    userSequence = [];
    tiles.forEach(t=> t.classList.remove('revealed'));
    revealedCount = 0;
    updateBgOpacity();
    setStatus('reiniciado');
    active = true;
  }

  function showLevelCompletePopup(){
    const overlay = document.getElementById('overlay');
    const L = LEVELS[currentLevelIndex];
    document.getElementById('overlayTitle').textContent = `Contexto ‚Äî ${L.label}`;
    document.getElementById('overlayText1').textContent = `Texto: historia t√©cnica y sociocultural de la versi√≥n ${L.label}.`;
    document.getElementById('overlayText2').textContent = `Apropiaciones y presentaci√≥n del siguiente nivel.`;
    overlay.style.display = 'flex';
  }
  function hideOverlay(){ document.getElementById('overlay').style.display = 'none'; }

  function nextLevel(){
    const next = currentLevelIndex + 1;
    if(next < LEVELS.length){ loadLevel(next); }
    else { alert('Has completado todos los niveles (demo).'); }
  }

  // Nota: no llamamos init() en load; solo inicializamos despu√©s del click en startBtn
</script>
</body>
</html>
