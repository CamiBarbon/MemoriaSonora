<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tilt+Neon&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
  <title>Juego: Memoria Sonora</title>
</head>
<body>

<!-- PANTALLA INICIAL -->
<div id="startScreen">
<div id="startTitle" class="neon-title">MEMORIA <span class="accent">SONORA</span></div>
  <button id="startBtn">COMENZAR</button>
  <div style="font-size:13px;color:#37bcdd;opacity:0.9">Hacé clic en comenzar para desbloquear el audio y ver el juego.</div>
</div>

<!-- TRANSICIÓN ENTRE START Y JUEGO -->
<div id="transitionScreen" class="transition-screen" style="display:none">
  <div class="transition-cd"></div>
</div>

<!-- JUEGO (oculto hasta click en comenzar) -->
<div class="stage" id="gameStage" style="display:none">
  <div class="header">
<div class="title neon-title">MEMORIA <span class="accent">SONORA</span></div>
    <div class="cd-wrap">
      <div id="cd" class="cd spin" title="CD preview"></div>
      <div style="font-size:12px;opacity:0.8">Nivel <span id="levelLabel">1</span></div>
    </div>
  </div>

  <div class="main">
    <div class="left-col">
      <div class="game-area">
        <div id="gridBack" class="grid-back">
          <!-- background under grid: usa la imagen en carpeta /img -->
          <div id="bgImage" class="bg-image" style="background-image: url('img/soft-cell.jpg');"></div>
          <div id="grid" class="grid"></div>
        </div>

        <div class="controls">
          <button id="repeatBtn" class="btn cyan">VOLVER A ESCUCHAR</button>
          <button id="advanceBtn" class="btn pink">AVANZAR</button>
        </div>
      </div>

      <div style="margin-top:8px;font-size:13px;color:#bfe9ff;opacity:0.9"><span id="status">esperando</span></div>
    </div>

    <aside class="right-col">
      <div class="sidebar">
        <h4>Cómo jugar</h4>
        <div class="instr" id="instructions">
          1) Prestá atención al fragmento del tema del inicio.<br>
          2) Luego, la cuadrícula se habilita. Cada casilla esconde un beat.<br>
          3) Clickeá para revelar los beats en orden. Si errás, la secuencia se reinicia.<br>
          4) Al completar, pasas de nivel! 
        </div>

        <div class="icons">
          <div class="icon"><strong>Soft Cell (1981)</strong></div>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- overlay (nivel completado) -->
<div id="overlay" class="overlay">
  <div class="card">
    <h3 id="overlayTitle">Historia y contexto</h3>
    <p id="overlayText1">(texto histórico técnico y sociocultural...)</p>
    <p id="overlayText2">(apropiaciones posteriores y presentación del siguiente nivel...)</p>
    <div class="card-actions">
      <button id="playNext" class="btn pink">JUGAR SIGUIENTE NIVEL</button>
    </div>
  </div>
</div>

<!-- audio (precargar preview; los beat individuales se crean al vuelo) -->
<audio id="previewAudio" src="mp3/level1_preview.mp3" preload="auto"></audio>

<script>
  /* CONFIG */
  const GRID_COLS = 4;
  const GRID_ROWS = 4;
  const TOTAL_TILES = GRID_COLS * GRID_ROWS; // 16
  const INITIAL_PREVIEW_MS = 25000; // 25s

  const LEVELS = [
    {
      id:1,label:'Soft Cell (1981)', bg:'img/soft-cell.jpg', preview:'mp3/level1_preview.mp3',
      // ejemplo de secuencia: 8 pasos (indices 0..19). Modificá según tu audio.
      correctSequence: [1, 2, 5, 6, 9, 10, 13, 14]
    }
  ];

  /* STATE */
  let currentLevelIndex = 0;
  let tiles = [];
  let userSequence = [];
  let active = false;
  let revealedCount = 0;

  /* DOM */
  const startBtn = document.getElementById('startBtn');
  const startScreen = document.getElementById('startScreen');
  const gameStage = document.getElementById('gameStage');
  const gridEl = document.getElementById('grid');
  const bgImage = document.getElementById('bgImage');
  const cd = document.getElementById('cd');
  const previewAudio = document.getElementById('previewAudio');
  const status = document.getElementById('status');
  const levelLabel = document.getElementById('levelLabel');

  function setStatus(s){ status.textContent = s }

  /* RENDER GRID (16 tiles) */
  function renderGrid(){
    gridEl.innerHTML = '';
    tiles = [];
    for(let i=0;i<TOTAL_TILES;i++){
      const t = document.createElement('div');
      t.className = 'tile';
      t.dataset.idx = i;
      t.addEventListener('click', ()=> onTileClick(i, t));
      gridEl.appendChild(t);
      tiles.push(t);
    }
  }

  /* Bind control buttons (repeat, advance, overlay) */
  function bindButtons(){
    document.getElementById('repeatBtn').addEventListener('click', ()=> playPreview());
    document.getElementById('advanceBtn').addEventListener('click', ()=> showLevelCompletePopup());
    document.getElementById('playNext').addEventListener('click', ()=> { hideOverlay(); nextLevel(); });
  }

  /* START BUTTON: muestra el juego y arranca el nivel (esto también desbloquea audio en navegadores) */
startBtn.addEventListener('click', ()=>{
  startScreen.style.display = 'none';

  const ts = document.getElementById('transitionScreen');
  ts.style.display = 'flex';

  setTimeout(()=>{
    ts.style.display = 'none';
    gameStage.style.display = 'block';
    initAfterStart();
  }, 1500);  // 1.5s transición CD
});

  function initAfterStart(){
    renderGrid();
    bindButtons();
    loadLevel(0);
  }

  /* LOAD LEVEL */
  function loadLevel(idx){
    currentLevelIndex = idx;
    const L = LEVELS[idx];
    levelLabel.textContent = L.id;
    bgImage.style.backgroundImage = `url('${L.bg}')`;
    previewAudio.src = L.preview;
    // reset tiles
    tiles.forEach(t=>{ t.classList.remove('revealed'); });
    userSequence = [];
    revealedCount = 0;
    updateBgOpacity();
    active = false;
    setStatus('Escuchá y recordá...');
    cd.classList.add('spin');
    playPreview().then(()=> {
      cd.classList.remove('spin');
      setTimeout(()=> { enableGrid(); }, 250);
    });
  }

  /* PLAY PREVIEW (respetar user gesture) */
  function playPreview(){
    return new Promise((resolve)=>{
      try {
        previewAudio.currentTime = 0;
        const playPromise = previewAudio.play();
        // If browser returns a promise, wait a bit; otherwise resolve after timeout
        if (playPromise !== undefined) {
          playPromise.catch(()=>{}).then(()=>{ /* started */ });
        }
      } catch(e){}
      setTimeout(()=>{ previewAudio.pause(); resolve(); }, INITIAL_PREVIEW_MS);
    });
  }

  function enableGrid(){
    // allow clicks; tiles are still visually translucent
    tiles.forEach(t=> t.classList.remove('revealed'));
    active = true; setStatus('¡Momento de jugar!');
  }

  /* When tile clicked */
  async function onTileClick(i, tileEl){
  if(!active) return;
  if(tileEl.classList.contains('revealed')) return;

  const level = LEVELS[currentLevelIndex];

  active = false; // bloqueamos clicks mientras suena el beat
  tileEl.classList.add('revealed'); // revela solo ese tile

  playBeat(level.id, i).then(()=>{
    userSequence.push(i);
    validateSequence();
    active = true; // desbloqueamos clicks
  });
}

  function updateBgOpacity(){
  const min = 0.40;  // más oscura al inicio
  const max = 0.75;  // más visible al final
  const ratio = Math.min(revealedCount / TOTAL_TILES, 1);
  const op = min + (max - min) * ratio;
  bgImage.style.opacity = op.toString();
}

  function playBeat(levelId, beatIndex){
  return new Promise((resolve)=>{
    const audio = new Audio(`mp3/level${levelId}_beat${beatIndex+1}.mp3`);
    audio.play().catch(()=>{}); // start playing
    audio.onended = resolve;     // cuando termina, resolve
  });
}

  function validateSequence(){
    const level = LEVELS[currentLevelIndex];
    const correct = level.correctSequence;
    // check prefix
    for(let k=0;k<userSequence.length;k++){
      if(userSequence[k] !== correct[k]){
        // mistake
        setStatus('No es el beat que sigue! Volvé a empezar :(');
        active = false;
        setTimeout(()=> {
          // hide reveals and reset sequence and revealedCount
          tiles.forEach(t=> t.classList.remove('revealed'));
          userSequence = [];
          revealedCount = 0;
          updateBgOpacity();
          active = true;
          setStatus('jugando');
        }, 800);
        return;
      }
    }
    // if completed
    if(userSequence.length === correct.length){
      setStatus('¡Buena memoria! lo lograste');
      active = false;
      setTimeout(()=> showLevelCompletePopup(), 500);
    } else {
      setStatus(`aciertos ${userSequence.length}/${correct.length}`);
    }
  }

  function resetGame(){
    userSequence = [];
    tiles.forEach(t=> t.classList.remove('revealed'));
    revealedCount = 0;
    updateBgOpacity();
    setStatus('Reiniciado');
    active = true;
  }

  function showLevelCompletePopup(){
    const overlay = document.getElementById('overlay');
    const L = LEVELS[currentLevelIndex];
    document.getElementById('overlayTitle').textContent = `Contexto — ${L.label}`;
    document.getElementById('overlayText1').textContent = `Texto: historia técnica y sociocultural de la versión ${L.label}.`;
    document.getElementById('overlayText2').textContent = `Apropiaciones y presentación del siguiente nivel.`;
    overlay.style.display = 'flex';
  }
  function hideOverlay(){ document.getElementById('overlay').style.display = 'none'; }

  function nextLevel(){
    const next = currentLevelIndex + 1;
    if(next < LEVELS.length){ loadLevel(next); }
    else { alert('Has completado todos los niveles (demo).'); }
  }

  // Nota: no llamamos init() en load; solo inicializamos después del click en startBtn
</script>
</body>
</html>
